<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Crypto News</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .article-content p {
            margin-bottom: 1rem;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Automated Crypto News</h1>
            <p class="text-lg text-gray-600 mt-2">Fresh articles generated by AI every 10 minutes.</p>
        </header>

        <main id="main-content">
            <!-- Status and Countdown Timer -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold">Status</h2>
                        <p id="status-message" class="text-gray-600">Initializing...</p>
                    </div>
                    <div class="text-right">
                        <h2 class="text-xl font-semibold">Next Article In</h2>
                        <p id="countdown-timer" class="text-2xl font-bold text-indigo-600">10:00</p>
                    </div>
                </div>
                <div id="loading-indicator" class="hidden mt-4">
                    <div class="flex items-center justify-center">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div>
                        <p>Generating new article...</p>
                    </div>
                </div>
            </div>

            <!-- Articles Section -->
            <div id="articles-container" class="space-y-8">
                <!-- Articles will be dynamically inserted here -->
                 <div class="bg-white rounded-lg shadow-md p-6 animate-pulse">
                    <div class="h-8 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="space-y-3">
                        <div class="h-4 bg-gray-200 rounded"></div>
                        <div class="h-4 bg-gray-200 rounded"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    </div>
                     <div class="text-sm text-gray-400 mt-4 h-4 bg-gray-200 rounded w-1/4"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'crypto-news-app';
        
        const POST_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes

        // --- DOM ELEMENTS ---
        const statusMessageEl = document.getElementById('status-message');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const articlesContainerEl = document.getElementById('articles-container');
        const loadingIndicatorEl = document.getElementById('loading-indicator');

        // --- FIREBASE INITIALIZATION ---
        let db, auth, userId;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            statusMessageEl.textContent = "Error: Could not connect to the database.";
            return;
        }
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User authenticated with UID:", userId);
                statusMessageEl.textContent = "Connected. Waiting for articles...";
                initialize();
            } else {
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    statusMessageEl.textContent = "Authentication failed.";
                }
            }
        });

        // --- CORE LOGIC ---
        function initialize() {
            listenForArticles();
            startArticleGenerationCycle();
        }

        /**
         * Sets up a real-time listener for new articles in Firestore.
         */
        function listenForArticles() {
            const articlesRef = collection(db, `artifacts/${appId}/public/data/articles`);
            const q = query(articlesRef, orderBy("createdAt", "desc"), limit(20));

            onSnapshot(q, (snapshot) => {
                statusMessageEl.textContent = "Receiving latest articles...";
                if (snapshot.empty) {
                    articlesContainerEl.innerHTML = '<p class="text-center text-gray-500">No articles found. The first one will be generated soon!</p>';
                } else {
                    articlesContainerEl.innerHTML = ''; // Clear existing
                    snapshot.forEach(doc => {
                        const article = doc.data();
                        displayArticle(article);
                    });
                }
                statusMessageEl.textContent = "Idle. Waiting for next schedule.";
            }, (error) => {
                console.error("Error listening for articles:", error);
                statusMessageEl.textContent = "Error fetching articles.";
            });
        }

        /**
         * Displays a single article in the UI.
         * @param {object} article - The article data from Firestore.
         */
        function displayArticle(article) {
            const articleEl = document.createElement('div');
            articleEl.className = 'bg-white rounded-lg shadow-md p-6 transition-transform duration-500 ease-out';
            
            const formattedDate = article.createdAt ? new Date(article.createdAt.seconds * 1000).toLocaleString() : 'Just now';

            // Sanitize content by replacing newlines with paragraphs for better formatting
            const formattedContent = article.content.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');

            articleEl.innerHTML = `
                <h3 class="text-2xl font-bold mb-3">${article.title}</h3>
                <div class="text-gray-700 article-content">${formattedContent}</div>
                <p class="text-sm text-gray-500 mt-4">Posted: ${formattedDate}</p>
            `;
            articlesContainerEl.appendChild(articleEl);
        }

        /**
         * Starts the main cycle of fetching, generating, and posting articles.
         */
        function startArticleGenerationCycle() {
            // Run immediately on startup, then set interval
            runJob(); 
            setInterval(runJob, POST_INTERVAL_MS);
            startCountdown(POST_INTERVAL_MS);
        }
        
        async function runJob() {
            console.log("Starting job: Fetching news and generating article...");
            statusMessageEl.textContent = "Fetching latest crypto news...";
            loadingIndicatorEl.classList.remove('hidden');

            try {
                const newsItem = await fetchCryptoNews();
                if (!newsItem) {
                    throw new Error("Could not fetch any news.");
                }

                statusMessageEl.textContent = `Generating article for: "${newsItem.title}"`;
                const articleContent = await generateArticle(newsItem);
                if (!articleContent) {
                    throw new Error("Failed to generate article content.");
                }

                statusMessageEl.textContent = "Posting new article...";
                await postArticleToFirestore(newsItem.title, articleContent);

                console.log("Job completed successfully.");
                statusMessageEl.textContent = "Idle. Waiting for next schedule.";

            } catch (error) {
                console.error("Article generation cycle failed:", error);
                statusMessageEl.textContent = `Error: ${error.message}`;
            } finally {
                loadingIndicatorEl.classList.add('hidden');
                startCountdown(POST_INTERVAL_MS); // Reset countdown after job completion/failure
            }
        }

        /**
         * Fetches the latest crypto news from a public API.
         * @returns {Promise<object|null>} A promise that resolves to a news item or null.
         */
        async function fetchCryptoNews() {
            // Using CryptoCompare's free news API
            const url = 'https://min-api.cryptocompare.com/data/v2/news/?lang=EN';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                const data = await response.json();
                if (data.Type === 100 && data.Data && data.Data.length > 0) {
                    const latestNews = data.Data[0];
                    console.log("Fetched news:", latestNews.title);
                    return { title: latestNews.title, body: latestNews.body };
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Failed to fetch crypto news:", error);
                return null;
            }
        }

        /**
         * Generates an article using the Gemini API.
         * @param {object} newsItem - The news item containing a title and body.
         * @returns {Promise<string|null>} A promise that resolves to the article text or null.
         */
        async function generateArticle(newsItem) {
            const prompt = `You are a crypto news analyst. Write a short, insightful news article based on the following headline and summary. The article should be objective, well-structured, and about 3-4 paragraphs long. Do not use markdown formatting.

Headline: "${newsItem.title}"

Summary: "${newsItem.body}"
`;
            const apiKey = ""; // Gemini API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Gemini API request failed with status ${response.status}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    console.log("Article generated successfully.");
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }
            } catch (error) {
                console.error("Error generating article with Gemini:", error);
                return null;
            }
        }

        /**
         * Saves the newly generated article to Firestore.
         * @param {string} title - The title of the article.
         * @param {string} content - The AI-generated content of the article.
         */
        async function postArticleToFirestore(title, content) {
            const articlesRef = collection(db, `artifacts/${appId}/public/data/articles`);
            try {
                await addDoc(articlesRef, {
                    title: title,
                    content: content,
                    createdAt: new Date(),
                });
                console.log("Article posted to Firestore.");
            } catch (error) {
                console.error("Error posting article to Firestore:", error);
            }
        }
        
        /**
         * Starts and updates the countdown timer in the UI.
         * @param {number} duration - The countdown duration in milliseconds.
         */
        function startCountdown(duration) {
            let timeLeft = duration;
            
            // Clear any existing timer
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }

            window.countdownInterval = setInterval(() => {
                timeLeft -= 1000;
                if (timeLeft < 0) {
                    timeLeft = 0;
                }
                const minutes = Math.floor((timeLeft / 1000) / 60);
                const seconds = Math.floor((timeLeft / 1000) % 60);
                countdownTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(window.countdownInterval);
                    countdownTimerEl.textContent = "00:00";
                }
            }, 1000);
        }
    </script>
</body>
</html>

